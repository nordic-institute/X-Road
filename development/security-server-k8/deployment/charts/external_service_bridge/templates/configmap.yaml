apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Values.service.name }}-host-resolver
  namespace: {{ .Values.service.namespace }}
data:
  resolve.sh: |
    #!/bin/sh
    IP=$(getent hosts {{ .Values.externalHost }}| awk '{ print $1 }')
    echo "apiVersion: v1
    kind: Endpoints
    metadata:
      name: {{ .Values.service.name }}
      namespace: {{ .Values.service.namespace }}
    subsets:
      - addresses:
          - ip: $IP
        ports:
          {{- range .Values.ports }}
          - port: {{ .targetPort }}
            name: {{ .name }}
          {{- end }}" | kubectl apply -f -
