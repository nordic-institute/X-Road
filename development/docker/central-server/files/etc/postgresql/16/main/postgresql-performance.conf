# PostgreSQL Performance Configuration for Single-Session Optimization
# This configuration is optimized for single-session performance with 4 CPU cores
# Memory settings assume at least 2GB RAM available for PostgreSQL
# Adjust based on your actual available memory

#------------------------------------------------------------------------------
# MEMORY SETTINGS
#------------------------------------------------------------------------------
# MEMORY USAGE BREAKDOWN:
# - BASELINE (always allocated at startup): shared_buffers + wal_buffers = ~272MB
# - ON-DEMAND (only when needed): work_mem, maintenance_work_mem
# - PLANNER HINT (not allocated): effective_cache_size
#
# Current baseline: ~272MB (256MB shared_buffers + 16MB wal_buffers)
# To reduce baseline further: lower shared_buffers to 128MB-192MB
# To maximize performance: increase shared_buffers to 512MB-1GB

# Shared memory buffers (ALWAYS ALLOCATED - baseline memory usage)
# Lower value = less memory at idle, but may reduce cache hit ratio under load
# Default: 128MB
# For low baseline: 256MB (current), For max performance: 512MB-1GB
shared_buffers = 256MB

# Effective cache size (PLANNER HINT ONLY - not actual memory allocation)
# This tells PostgreSQL how much memory is available for caching (OS cache + shared_buffers)
# Used by query planner to choose better plans, doesn't allocate memory
# Default: 4GB, Recommended: 50-75% of total RAM available to PostgreSQL
effective_cache_size = 1536MB

# Work memory per operation (ONLY USED WHEN NEEDED - not baseline)
# This is used for sorting, hash joins, etc. per operation
# With single session, this can be much higher since only one connection uses it
# Higher values = better performance for complex queries, but only allocated during operations
# Default: 4MB, Recommended for single session: 64MB-256MB
work_mem = 128MB

# Maintenance work memory (for VACUUM, CREATE INDEX, etc.)
# Increased for faster index creation in Liquibase schema operations
# Default: 64MB, Recommended: 256MB-512MB
maintenance_work_mem = 512MB

# WAL buffers (ALWAYS ALLOCATED - baseline memory usage)
# Default: -1 (auto, ~16MB), Recommended: 16MB-32MB
# Can reduce to 8MB for lower baseline if needed (may slightly reduce write performance)
wal_buffers = 16MB

#------------------------------------------------------------------------------
# QUERY TUNING
#------------------------------------------------------------------------------

# Random page cost (lower for SSD storage)
# Default: 4.0, Recommended for SSD: 1.1-1.5
random_page_cost = 1.1

# Effective IO concurrency (higher for SSD)
# Default: 1, Recommended for SSD: 200-300
effective_io_concurrency = 200

# Default statistics target (higher = better query plans, more time to analyze)
# Default: 100, Recommended: 200-500
default_statistics_target = 200

#------------------------------------------------------------------------------
# PARALLEL QUERY SETTINGS
#------------------------------------------------------------------------------

# Maximum worker processes (should match CPU cores)
# Default: 8, Recommended for 4 cores: 4
max_worker_processes = 4

# Maximum parallel workers per gather
# Default: 2, Recommended for 4 cores: 2-3
max_parallel_workers_per_gather = 2

# Maximum parallel workers
# Default: 8, Recommended for 4 cores: 4
max_parallel_workers = 4

# Minimum parallel table scan size
# Default: 8MB, Recommended: 1MB-2MB (allows more parallel scans)
min_parallel_table_scan_size = 1MB

# Minimum parallel index scan size
# Default: 512kB, Recommended: 512kB (keep default)
min_parallel_index_scan_size = 512kB

#------------------------------------------------------------------------------
# WRITE PERFORMANCE
#------------------------------------------------------------------------------

# Checkpoint completion target (0.0-1.0)
# Higher values spread checkpoint I/O over more time
# Default: 0.9, Recommended: 0.9-0.95
checkpoint_completion_target = 0.9

# Maximum WAL size before checkpoint
# Default: 1GB, Recommended: 2GB-4GB
max_wal_size = 2GB

# Minimum WAL size before checkpoint
# Default: 80MB, Recommended: 256MB-512MB
min_wal_size = 256MB

#------------------------------------------------------------------------------
# CONNECTION SETTINGS
#------------------------------------------------------------------------------

# Maximum connections (lower is fine for single session focus)
# Default: 100, Recommended for single session: 20-50
max_connections = 100

#------------------------------------------------------------------------------
# LOGGING (optional, can help with debugging slow queries)
#------------------------------------------------------------------------------

# Log slow queries (uncomment if needed)
# log_min_duration_statement = 1000  # Log queries taking longer than 1 second

#------------------------------------------------------------------------------
# AUTOVACUUM & STATISTICS (optimized for frequent schema drops/recreates)
#------------------------------------------------------------------------------

# Autovacuum is important for performance
autovacuum = on

# More aggressive autovacuum for frequent schema operations (TEST ENVIRONMENT)
# Lower naptime = more frequent checks, important for frequent drops/recreates
autovacuum_max_workers = 2
autovacuum_naptime = 2s  # Very aggressive for test environments with frequent schema changes

# Auto-analyze settings (critical for query planner performance)
# Force statistics updates more frequently to prevent planner degradation
autovacuum_analyze_scale_factor = 0.01  # Default: 0.1, Lower = analyze more often
autovacuum_analyze_threshold = 10       # Default: 50, Lower = analyze smaller tables

# Autovacuum thresholds (more aggressive for test environments)
autovacuum_vacuum_scale_factor = 0.05   # Default: 0.2, Lower = vacuum more often
autovacuum_vacuum_threshold = 10        # Default: 50, Lower = vacuum smaller tables

# Force statistics collection on schema operations
# This helps prevent query planner degradation over time
default_statistics_target = 100  # Reduced from 200 - faster stats collection, still good plans

#------------------------------------------------------------------------------
# TEST ENVIRONMENT OPTIMIZATIONS (No recovery/audit needed)
#------------------------------------------------------------------------------

# Disable fsync for maximum speed (TEST ONLY - data loss risk on crash)
# This provides significant write performance boost for test environments
# Default: on, For tests: off (much faster writes)
fsync = off

# Disable synchronous commit (TEST ONLY - faster commits, no durability guarantee)
# Default: on, For tests: off
synchronous_commit = off

# Reduce WAL overhead (minimal logging for tests, no recovery needed)
# Default: replica, For tests: minimal (much faster, no point-in-time recovery)
wal_level = minimal

# Disable WAL streaming/replication (TEST ONLY - no replication needed)
# Required when wal_level = minimal, otherwise PostgreSQL will error
# Default: 0, but may be set elsewhere - explicitly disable for tests
max_wal_senders = 0

# Disable replication slots (TEST ONLY - no replication needed)
# Default: 0, but explicitly set for clarity
max_replication_slots = 0

# Disable full page writes (TEST ONLY - faster checkpoints, no crash recovery)
# Default: on, For tests: off
full_page_writes = off

# Reduce checkpoint frequency (less overhead, acceptable for tests)
# Default: 5min, For tests: 15min (less frequent checkpoints = better performance)
checkpoint_timeout = 15min

# Larger WAL segments before checkpoint (less frequent checkpoints)
# Already set above, but can be even larger for tests
max_wal_size = 4GB

# Disable logging overhead (TEST ONLY - no audit trail needed)
# Default: various logging enabled, For tests: minimal logging
logging_collector = off
log_destination = 'stderr'
log_min_messages = warning
log_min_error_statement = error
log_min_duration_statement = -1  # Disable slow query logging

# Disable statement statistics (reduces overhead)
# Default: on, For tests: off
track_io_timing = off
track_functions = none
track_activity_query_size = 1024  # Smaller than default (2KB)

# Reduce connection overhead
# Default: various, For tests: minimal
log_connections = off
log_disconnections = off
log_duration = off
log_line_prefix = ''  # No prefix overhead

# Reduce query plan statistics overhead (keep track_counts for query planning)
# track_counts should stay on for query optimization, but reduce other stats
# stats_temp_directory = 'pg_stat_tmp'  # Already default

#------------------------------------------------------------------------------
# SCHEMA OPERATIONS OPTIMIZATION (for frequent drops/recreates)
#------------------------------------------------------------------------------

# Disable expensive statistics collection that accumulates over time
# These can cause performance degradation with frequent schema operations
track_counts = on  # Keep on - needed for query planning
track_io_timing = off  # Already set above - reduces overhead
track_functions = none  # Already set above - reduces overhead

# Reduce system catalog bloat from frequent schema operations
# Vacuum system catalogs more aggressively
vacuum_cost_delay = 0  # No delay for vacuum operations (TEST ONLY)
vacuum_cost_page_hit = 1  # Default: 1
vacuum_cost_page_miss = 2  # Default: 10, Lower = faster vacuum
vacuum_cost_page_dirty = 5  # Default: 20, Lower = faster vacuum

# Faster DDL operations (for CREATE/DROP TABLE, INDEX, etc.)
# Reduce lock timeouts for schema operations
lock_timeout = 0  # No timeout (TEST ONLY - may cause hangs in production)
statement_timeout = 0  # No timeout (TEST ONLY)

