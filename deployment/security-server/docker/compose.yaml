services:
  db-serverconf:
    image: postgres:17
    environment:
      - POSTGRES_PASSWORD=secret #TODO use separate users for runtime and admin see: https://hub.docker.com/_/postgres
      - POSTGRES_USER=serverconf
    networks:
      - xrd-ss-network
    deploy:
      resources:
        reservations:
          memory: 64M
        limits:
          memory: 256M
  #    volumes: TODO not required for now
  #        - db-volume:/var/lib/postgresql/data
  db-messagelog:
    image: postgres:17
    environment:
      - POSTGRES_PASSWORD=secret #TODO use separate users
      - POSTGRES_USER=messagelog
    networks:
      - xrd-ss-network
    deploy:
      resources:
        reservations:
          memory: 64M
        limits:
          memory: 256M
  #    volumes: TODO not required for now
  #        - db-volume:/var/lib/postgresql/data
  db-serverconf-init:
    image: ${SERVERCONF_INIT_IMG}
    pull_policy: always
    environment:
      - LIQUIBASE_COMMAND_USERNAME=serverconf
      - LIQUIBASE_COMMAND_PASSWORD=secret
      - LIQUIBASE_COMMAND_URL=jdbc:postgresql://db-serverconf:5432/serverconf
      - db_user=serverconf
      - db_schema=public
    depends_on:
      - db-serverconf
    networks:
      - xrd-ss-network
    deploy:
      resources:
        reservations:
          memory: 64M
        limits:
          memory: 512M
  db-messagelog-init:
    image: liquibase:4.31 #TODO probably release standalone image with embedded changelog
    volumes:
      - ./../../src/packages/src/xroad/common/addon/proxy/:/liquibase/changelog
    environment:
      - db_user=messagelog
      - db_schema=public
    command:
      - --changeLogFile=changelog/messagelog-changelog.xml
      - --driver=org.postgresql.Driver
      - --url=jdbc:postgresql://db-messagelog:5432/messagelog
      - --username=messagelog
      - --password=secret
      - --log-level=debug
      - update
    depends_on:
      - db-messagelog
    networks:
      - xrd-ss-network
    deploy:
      resources:
        reservations:
          memory: 64M
        limits:
          memory: 512M

  configuration-client:
    image: ${CONFIGURATION_CLIENT_IMG}
    pull_policy: always
    environment:
      - XROAD_HOST=confclient
    healthcheck:
      interval: 5s
      retries: 40
      test: [ "CMD", "curl", "-f", "-k", "http://localhost:4099/q/health" ]
    networks:
      - xrd-ss-network
      - xroad-network
    #    depends_on:
    #      config:
    #        condition: service_healthy
    deploy:
      resources:
        reservations:
          memory: 64M
        limits:
          memory: 320M
  signer:
    image: ${SIGNER_IMG}
    pull_policy: always
    environment:
      - XROAD_CONFIG_SERVER_URI=http://config:5580
      - XROAD_HOST=signer
#    volumes:
#      - ./temp-mount-xroad:/etc/xroad
    healthcheck:
      interval: 5s
      retries: 40
      test: [ "CMD", "curl", "-f", "-k", "http://localhost:4099/q/health" ]
    networks:
      - xroad-network
      - xrd-ss-network
    depends_on:
      db-serverconf-init:
        condition: service_completed_successfully
      #      config:
      #        condition: service_healthy
      configuration-client:
        condition: service_healthy
    deploy:
      resources:
        reservations:
          memory: 64M
        limits:
          memory: 320M
  proxy:
    image: ${PROXY_IMG}
    pull_policy: always
    environment:
      - XROAD_DB_MESSAGELOG_HIBERNATE_CONNECTION_URL=jdbc:postgresql://db-messagelog:5432/messagelog
      - XROAD_DB_MESSAGELOG_HIBERNATE_CONNECTION_DRIVER_CLASS=org.postgresql.Driver
      - XROAD_DB_MESSAGELOG_HIBERNATE_CONNECTION_USERNAME=messagelog
      - XROAD_DB_MESSAGELOG_HIBERNATE_CONNECTION_PASSWORD=secret
      - XROAD_DB_SERVERCONF_HIBERNATE_CONNECTION_URL=jdbc:postgresql://db-serverconf:5432/serverconf
      - XROAD_DB_MESSAGELOG_HIBERNATE_CONNECTION_DRIVER_CLASS=org.postgresql.Driver
      - XROAD_DB_SERVERCONF_HIBERNATE_CONNECTION_USERNAME=serverconf
      - XROAD_DB_SERVERCONF_HIBERNATE_CONNECTION_PASSWORD=secret
      - XROAD_HOST=proxy
#    volumes:
#      - ./temp-mount-xroad:/etc/xroad
    healthcheck:
      interval: 5s
      retries: 40
      test: [ "CMD", "curl", "-f", "-k", "http://localhost:4099/q/health" ]
    networks:
      - xrd-ss-network
      - xroad-network
    depends_on:
      db-serverconf-init:
        condition: service_completed_successfully
      signer:
        condition: service_healthy
    ports:
      - "9999:9999"
    deploy:
      resources:
        reservations:
          memory: 64M
        limits:
          memory: 512M
  ui:
    image: ${PROXY_UI_IMG}
    pull_policy: always
    environment:
      - XROAD_CONFIG_SERVER_URI=http://config:5580
#    volumes:
#      - ./temp-mount-xroad:/etc/xroad
#      - ./temp-scripts:/usr/share/xroad/scripts
    ports:
      - "4700:4000" # Frontend
      - "4790:9999" # debug port
    healthcheck:
      interval: 5s
      retries: 40
      test: [ "CMD", "curl", "-f", "-k",  "https://localhost:4000/actuator/health" ]
    networks:
      - xrd-ss-network
      - xroad-network
    depends_on:
      db-serverconf-init:
        condition: service_completed_successfully
      signer:
        condition: service_healthy
    deploy:
      resources:
        reservations:
          memory: 64M
        limits:
          memory: 512M

volumes:
  db-volume:
networks:
  xroad-network:
    name: xroad-network
  #    external: true
  xrd-ss-network:
    driver: bridge
