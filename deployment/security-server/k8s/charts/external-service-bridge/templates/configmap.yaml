apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Values.service.name }}-host-resolver
  namespace: {{ .Values.service.namespace }}
data:
  resolve.sh: |
    #!/bin/sh
    IP=$(getent ahosts {{ .Values.externalHost }} | awk '$1 ~ /^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$/ { print $1; exit }')
    echo "apiVersion: v1
    kind: Endpoints
    metadata:
      name: {{ .Values.service.name }}
      namespace: {{ .Values.service.namespace }}
    subsets:
      - addresses:
          - ip: $IP
        ports:
          {{- range .Values.ports }}
          - port: {{ .targetPort }}
            name: {{ .name }}
          {{- end }}" | kubectl apply -f -
