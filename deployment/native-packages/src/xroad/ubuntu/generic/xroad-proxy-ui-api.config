#!/bin/bash
. /usr/share/debconf/confmodule

get_prop() {
  /usr/share/xroad/scripts/yaml_helper.sh get "$1" "$2" 2>/dev/null
}

if [ "$1" = "configure" ] || [ "$1" = "reconfigure" ]; then
  while :; do
    RET=""
    if db_input high xroad-common/username; [ $? -eq 30 ]; then
      # https://manpages.ubuntu.com/manpages/focal/man7/debconf-devel.7.html
      # 30 = user did not see the question (e.g. noninteractive config frontend)
      break
    fi
    db_go
    db_get xroad-common/username
    if [ -n "$RET" ] && getent passwd "$RET" &>/dev/null
    then
      break
    fi
    db_input critical xroad-common/non_existing_user
    db_fset xroad-common/username seen false
    db_go
  done

  # prepare tls settings
  CONFIG_FILE="/etc/xroad/conf.d/local-tls.yaml"
  if [[ -z $(get_prop "$CONFIG_FILE" 'xroad.proxy-ui-api.tls.certificate-provisioning.common-name') && \
      -z $(get_prop "$CONFIG_FILE" 'xroad.proxy-ui-api.tls.certificate-provisioning.alt-names') && \
      -z $(get_prop "$CONFIG_FILE" 'xroad.proxy-ui-api.tls.certificate-provisioning.ip-subject-alt-names') ]]; then

    HOST=$(hostname -f)
    if (( ${#HOST} > 64 )); then
      HOST="$(hostname -s)"
    fi
    LIST=
    for i in $(ip addr | grep 'scope global' | tr '/' ' ' | awk '{print $2}'); do LIST+="IP:$i,"; done;
    ALT="${LIST}DNS:$(hostname -f),DNS:$(hostname -s)"

    db_subst xroad-common/proxy-ui-api-subject HOST "$HOST"
    db_subst xroad-common/proxy-ui-api-altsubject ALT "$ALT"

    db_get xroad-common/proxy-ui-api-subject
    [ -z "$RET" ] && db_set xroad-common/proxy-ui-api-subject "$HOST"
    db_get xroad-common/proxy-ui-api-altsubject
    [ -z "$RET" ] && db_set xroad-common/proxy-ui-api-altsubject "$ALT"

    db_beginblock
    db_input critical xroad-common/proxy-ui-api-subject || true
    db_input critical xroad-common/proxy-ui-api-altsubject || true
    db_endblock
    db_go
  fi

fi

db_stop
