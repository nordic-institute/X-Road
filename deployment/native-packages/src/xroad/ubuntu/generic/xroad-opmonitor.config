#!/bin/bash
. /usr/share/debconf/confmodule

get_prop() {
  /usr/share/xroad/scripts/yaml_helper.sh get "$1" "$2" 2>/dev/null
}

if [ "$1" = "configure" ] || [ "$1" = "reconfigure" ]; then
  # prepare tls settings
  CONFIG_FILE="/etc/xroad/conf.d/local-tls.yaml"
  if [[ -z $(get_prop "$CONFIG_FILE" 'xroad.op-monitor.tls.certificate-provisioning.common-name') && \
          -z $(get_prop "$CONFIG_FILE" 'xroad.op-monitor.tls.certificate-provisioning.alt-names') && \
          -z $(get_prop "$CONFIG_FILE" 'xroad.op-monitor.tls.certificate-provisioning.ip-subject-alt-names') ]]; then
    HOST=$(hostname -f)
    if (( ${#HOST} > 64 )); then
      HOST="$(hostname -s)"
    fi
    LIST=
    for i in $(ip addr | grep 'scope global' | tr '/' ' ' | awk '{print $2}'); do LIST+="IP:$i,"; done;
    ALT="${LIST}DNS:$(hostname -f),DNS:$(hostname -s)"

    db_subst xroad-common/service-subject HOST "$HOST"
    db_subst xroad-common/service-altsubject ALT "$ALT"

    db_get xroad-common/service-subject
    [ -z "$RET" ] && db_set xroad-common/service-subject "$HOST"

    db_get xroad-common/service-altsubject
    [ -z "$RET" ] && db_set xroad-common/service-altsubject "$ALT"

    db_beginblock
    db_input critical xroad-common/service-subject || true
    db_input critical xroad-common/service-altsubject || true
    db_endblock
    db_go
  fi
fi

db_stop
