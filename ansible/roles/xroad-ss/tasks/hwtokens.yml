---
- name: Configure SoftHSM token for X-Road
  become: true
  when:
    - "'ubuntu_hsm_ss' in group_names"
  block:
    - name: Ensure apt cache is up to date
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install X-Road hardware token addon
      apt:
        name: xroad-addon-hwtokens
        state: present

    - name: Install SoftHSM2
      apt:
        name: softhsm2
        state: present

    - name: Ensure 'xroad' user is in 'softhsm' group
      user:
        name: xroad
        append: yes
        groups: softhsm

    - name: Read SoftHSM slots (before)
      command: softhsm2-util --show-slots
      register: softhsm_slots_before
      changed_when: false

    - name: Initialize SoftHSM token if label not present
      command: >
        softhsm2-util --init-token
        --slot 0
        --label {{ hwtoken_label | quote }}
        --so-pin {{ hwtoken_so_pin | quote }}
        --pin {{ hwtoken_user_pin | quote }}
      when: softhsm_slots_before.stdout is not search(hwtoken_label | regex_escape)
      register: init_result
      changed_when: init_result.rc == 0

    - name: Read SoftHSM slots (after)
      command: softhsm2-util --show-slots
      register: softhsm_slots_after
      changed_when: false

    - name: Get slot id for token label
      shell: |
        softhsm2-util --show-slots | awk '
          /^Slot[[:space:]]+/ { slot=$2 }
          /Label:[[:space:]]*{{ hwtoken_label | regex_escape }}/ { print slot; exit }'
      args:
        executable: /bin/bash
      register: slot_id_cmd
      changed_when: false

    - name: Set slot id fact
      set_fact:
        softhsm2_slot_id: "{{ slot_id_cmd.stdout | trim }}"

    - name: Fail if slot id not found for token label
      fail:
        msg: "Could not determine slot id for SoftHSM token label '{{ hwtoken_label }}'. Output was: {{ softhsm_slots_after.stdout }}"
      when: softhsm2_slot_id == ""

    - name: Ensure devices.ini exists
      file:
        path: "/etc/xroad/devices.ini"
        state: touch
        owner: root
        group: root
        mode: "0644"

    - name: Configure SoftHSM as a hardware token in X-Road devices.ini
      blockinfile:
        path: "/etc/xroad/devices.ini"
        marker: "# {mark} ANSIBLE MANAGED BLOCK (SoftHSM)"
        block: |
          [softhsm2]
          library = /usr/lib/softhsm/libsofthsm2.so
          slot_ids = {{ softhsm2_slot_id }}
          token_id_format = 1
          os_locking_ok = true
          library_cant_create_os_threads = true
    
    - name: Recursively chown tokens to xroad
      become: true
      file:
        path: /var/lib/softhsm/tokens
        state: directory
        owner: xroad
        recurse: yes