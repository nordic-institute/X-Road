---
- name: configure remote database
  # can not be used to reconfigure a database
  block:
    - name: install remote database package
      yum:
        name: "xroad-database-remote"
        state: latest

    - name: xroad.properties template
      template:
        src: "xroad.properties"
        dest: "/etc/xroad.properties"
        owner: "root"
        group: "root"
        mode: 0600
        force: no
  when: (database_admin_password is defined) and (database_admin_password != "")
  tags:
    - install-xroad-ss-packages

- name: install xroad packages and dependencies from set up repository (RHEL8)
  shell: |
    set -euo pipefail
    pkgs="{{ vars['xroad_varpkg_' + variant] if (vars['xroad_varpkg_' + variant] is string)
            else (vars['xroad_varpkg_' + variant] | join(' ')) }}"
    dnf -y install $pkgs
  when:
    - ansible_os_family == 'RedHat'
    - ansible_distribution_major_version | int == 8
  tags:
    - install-xroad-ss-packages

- name: install xroad packages and dependencies from set up repository (RHEL9+)
  yum:
    name: "{{ vars['xroad_varpkg_' + variant] }}"
    state: latest
  when:
    - ansible_os_family == 'RedHat'
    - ansible_distribution_major_version | int >= 9
  tags: [install-xroad-ss-packages]

- name: install opmonitoring (RHEL8)
  shell: |
    set -euo pipefail
    dnf -y install xroad-addon-opmonitoring
  when:
    - ansible_os_family == 'RedHat'
    - ansible_distribution_major_version | int == 8
    - xroad_install_opmonitoring | default(false)
  tags:
    - install-xroad-ss-packages

- name: install opmonitoring (RHEL9+)
  yum:
    name: xroad-addon-opmonitoring
    state: latest
  when:
    - ansible_os_family == 'RedHat'
    - ansible_distribution_major_version | int >= 9
    - xroad_install_opmonitoring | default(false)
  tags:
    - install-xroad-ss-packages

- name: db.properties template (final, after all packages)
  template:
    src: db.properties
    dest: /etc/xroad/db.properties
    owner: xroad
    group: xroad
    mode: "0640"
    force: yes
  when: (database_admin_password is defined) and (database_admin_password != "")
  tags:
    - install-xroad-ss-packages

- name: Verify db.properties contains required DB URLs
  shell: |
    set -euo pipefail
    grep -q '^serverconf\.hibernate\.connection\.url' /etc/xroad/db.properties
    grep -q '^messagelog\.hibernate\.connection\.url' /etc/xroad/db.properties
    grep -q '^op-monitor\.hibernate\.connection\.url' /etc/xroad/db.properties
  changed_when: false
  when: (database_admin_password is defined) and (database_admin_password != "")
  tags:
    - install-xroad-ss-packages

- name: add xroad admin user
  command: "xroad-add-admin-user {{ xroad_ui_user }}"
  tags:
    - install-xroad-ss-packages

- name: start xroad-proxy (RHEL)
  service:
    name: xroad-proxy
    state: started
  tags:
    - install-xroad-ss-packages
