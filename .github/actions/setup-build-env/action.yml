name: 'Setup Build Environment'
description: 'Set up Java, Gradle, Docker and other tools for X-Road builds'
inputs:
  java-version:
    description: 'Java version to set up'
    required: false
    default: '21'
  gradle-cache-read-only:
    description: 'Whether Gradle cache should be read-only'
    required: false
    default: 'false'
  setup-docker-buildx:
    description: 'Whether to set up Docker Buildx for multi-platform image building'
    required: false
    default: 'false'
  setup-packaging-tools:
    description: 'Whether to install packaging tools (debhelper, devscripts)'
    required: false
    default: 'false'
  free-disk-space:
    description: 'Whether to free up disk space'
    required: false 
    default: 'false'

runs:
  using: 'composite'
  steps:
    - name: Log initial storage
      uses: ./.github/actions/log-storage
      with:
        label: 'Initial Storage Utilization'
        show-top-dirs: 'true'

    - name: Install packaging tools
      if: inputs.setup-packaging-tools == 'true' && runner.os == 'Linux'
      shell: bash
      env:
        DEBIAN_FRONTEND: noninteractive
      run: sudo apt-get update && sudo apt-get install -y curl software-properties-common build-essential unzip debhelper devscripts

    - name: Free Disk Space (Ubuntu)
      if: inputs.free-disk-space == 'true' && runner.os == 'Linux'
      uses: jlumbroso/free-disk-space@main
      with:
        android: true
        dotnet: true
        haskell: true

    - name: Set up JDK ${{ inputs.java-version }}
      uses: actions/setup-java@v5
      with:
        java-version: ${{ inputs.java-version }}
        distribution: 'temurin'

    - name: Set up Gradle
      uses: gradle/actions/setup-gradle@v4
      with:
        cache-read-only: ${{ inputs.gradle-cache-read-only }}
        gradle-home-cache-cleanup: true
        dependency-graph: generate-and-submit
        add-job-summary-as-pr-comment: always
        build-scan-publish: true
        build-scan-terms-of-use-url: "https://gradle.com/terms-of-service"
        build-scan-terms-of-use-agree: "yes"

    - name: Set up Docker Buildx
      if: inputs.setup-docker-buildx == 'true'
      uses: docker/setup-buildx-action@v3
      with:
        driver-opts: network=host

    - name: Log post-setup storage
      uses: ./.github/actions/log-storage
      with:
        label: 'Post-Setup Storage Utilization'
