name: Build and Package

on:
  workflow_call:
    inputs:
      ref:
        description: 'Git ref to checkout'
        required: true
        type: string
      sha:
        description: 'Git SHA for the build'
        required: true
        type: string

jobs:
  build-and-package:
    name: Build, test and package code
    runs-on: ubuntu-24.04
    steps:
      - name: Start Measurement
        uses: green-coding-solutions/eco-ci-energy-estimation@v5.0
        with:
          task: start-measurement
          label: 'Build, unit tests and packaging'

      - uses: actions/checkout@v5
        with:
          ref: ${{ inputs.ref }}
          fetch-depth: 0  # SonarCloud: Shallow clones should be disabled for a better relevancy of analysis

      - name: Setup build environment
        uses: ./.github/actions/setup-build-env
        with:
          gradle-cache-read-only: ${{ github.ref != 'refs/heads/develop' }}
          setup-docker: true
          free-disk-space: false

      - name: Build, test and package code setup measurement
        uses: green-coding-solutions/eco-ci-energy-estimation@v5.0
        with:
          task: get-measurement
          label: 'Build environment setup'

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and test source
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        working-directory: ./src
        run: |
          # Setup GHCR registry URL (unified for both base images and application images)
          REPO_LOWERCASE=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          IMAGE_REGISTRY="ghcr.io/${REPO_LOWERCASE}"
          
          # Read version and build type from gradle.properties for service image tagging
          XROAD_VERSION=$(grep "^xroadVersion=" gradle.properties | cut -d'=' -f2 | tr -d ' ')
          XROAD_BUILD_TYPE=$(grep "^xroadBuildType=" gradle.properties | cut -d'=' -f2 | tr -d ' ')
          
          # Function to get branch name for service image tagging
          get_branch_name() {
            local branch_name=""
            # For pull requests, prioritize head_ref (actual source branch) over ref_name (merge branch)
            if [[ -n "${{ github.head_ref }}" ]]; then
              branch_name="${{ github.head_ref }}"
              echo "üîç Using PR source branch: ${branch_name}" >&2
            elif [[ -n "${{ github.ref_name }}" ]]; then
              branch_name="${{ github.ref_name }}"
              echo "üîç Using ref branch: ${branch_name}" >&2
            else
              branch_name="unknown"
              echo "‚ö†Ô∏è No branch name found, using: ${branch_name}" >&2
            fi
            # Clean up branch name for Docker tag compatibility
            echo "$branch_name" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-zA-Z0-9._-]/-/g' | sed 's/--*/-/g' | sed 's/^-\|-$//g'
          }
          
          # Determine service image suffix for branch-aware tagging
          BRANCH_NAME=$(get_branch_name)
          
          if [[ "${{ github.ref_type }}" == "tag" || "$XROAD_BUILD_TYPE" == "RELEASE" ]]; then
            # For releases, use simple version
            SERVICE_IMAGE_TAG="${XROAD_VERSION}"
          elif [[ "$BRANCH_NAME" == "develop-8.x" ]]; then
            # For develop branch, keep compatibility
            SERVICE_IMAGE_TAG="${XROAD_VERSION}-SNAPSHOT"
          else
            # For feature branches, include branch name
            SERVICE_IMAGE_TAG="${XROAD_VERSION}-SNAPSHOT-${BRANCH_NAME}"
          fi
          
          echo "üèóÔ∏è Build configuration:"
          echo "  Registry: ${IMAGE_REGISTRY}"
          echo "  Service Image Tag: ${SERVICE_IMAGE_TAG}"
          echo "  Branch: ${BRANCH_NAME}"
          
          ./gradlew -Dorg.gradle.jvmargs=-Xmx6g \
          -PsonarqubeHost=https://sonarcloud.io -PsonarqubeProjectKey=nordic-institute_X-Road -PsonarqubeOrganization=nordic-institute \
          build sonar test jacocoTestReport -Pfrontend-npm-audit \
          -PbuildImages=true \
          -PxroadImageRegistry=${IMAGE_REGISTRY} \
          -PxroadServiceImageTag=${SERVICE_IMAGE_TAG}
      - name: Test report
        env:
          NODE_OPTIONS: '--max-old-space-size=6144'
        uses: dorny/test-reporter@v2
        if: success() || failure()
        with:
          name: Unit and integration tests
          path: src/**/build/test-results/**/TEST-*.xml
          reporter: java-junit
          list-suites: 'failed'
          list-tests: 'failed'

      - name: Upload intTest reports
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: Integration Test reports
          path: |
            src/service/signer/signer-int-test/build/allure-report/
            src/service/signer/signer-int-test/build/container-logs/
            src/service/op-monitor/op-monitor-int-test/build/allure-report/
            src/service/op-monitor/op-monitor-int-test/build/container-logs/

      - name: Build, test and package code execution measurement
        uses: green-coding-solutions/eco-ci-energy-estimation@v5.0
        with:
          task: get-measurement
          label: 'Build, unit tests and packaging'

      - name: Build RHEL8 packages
        run: |
          docker build -t rhel8 ${{ github.workspace }}/deployment/native-packages/docker/rpm-el8/ && docker run --rm -u $(id -u ${USER}):$(id -g ${USER}) -v /etc/passwd:/etc/passwd:ro -v /etc/group:/etc/group:ro -v ${{ github.workspace }}:/workspace rhel8 ./deployment/native-packages/build-rpm.sh
          echo "Packages built successfully, removing packages.."
          rm -rf ${{ github.workspace }}/deployment/native-packages/build/rhel/8

      - name: Build RHEL9 packages
        run: |
          docker build -t rhel9 ${{ github.workspace }}/deployment/native-packages/docker/rpm-el9/ && docker run --rm -u $(id -u ${USER}):$(id -g ${USER}) -v /etc/passwd:/etc/passwd:ro -v /etc/group:/etc/group:ro -v ${{ github.workspace }}:/workspace rhel9 ./deployment/native-packages/build-rpm.sh
          echo "Packages built successfully, removing packages.."
          rm -rf ${{ github.workspace }}/deployment/native-packages/build/rhel/9

      - name: Build 22.04 (Jammy) packages
        env:
          DEBEMAIL: 'info@niis.org'
          DEBFULLNAME: 'NIIS'
        run: ./deployment/native-packages/build-deb.sh jammy -release

      - name: Build 24.04 (Noble) packages
        env:
          DEBEMAIL: 'info@niis.org'
          DEBFULLNAME: 'NIIS'
        run: |
          ./deployment/native-packages/build-deb.sh noble -release
          echo "Packages built successfully, removing packages.."
          rm -rf ${{ github.workspace }}/deployment/native-packages/build/ubuntu24.04

      - name: Store deb files for system tests
        uses: actions/upload-artifact@v4
        with:
          name: debian-packages
          path: deployment/native-packages/build/ubuntu22.04/*.deb
          compression-level: 0 #No point in compressing these

      - name: Packaging and upload artifacts measurement
        uses: green-coding-solutions/eco-ci-energy-estimation@v5.0
        with:
          task: get-measurement
          label: 'Packaging and upload artifacts'

      - name: Show Energy Results
        uses: green-coding-solutions/eco-ci-energy-estimation@v5.0
        with:
          task: display-results
          pr-comment: true

      - name: Clean up workspace #otherwise might run out of disk space in the next steps
        working-directory: ./src
        run: ./gradlew clean