name: X-Road tests
on: [push]
jobs:
  BuildAndPackageWithUnitTests:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v3
        with:
          submodules: 'true'
      - name: Set up JDK 11 
        uses: actions/setup-java@v3
        with:
          java-version: '11'
          distribution: 'temurin'
      - name: Ensure required packages
        run: sudo apt-get install -y curl software-properties-common build-essential unzip debhelper devscripts
      - name: Set up Gradle
        uses: gradle/gradle-build-action@v2
      - name: Build in parallel
        working-directory: ./src
        run: ./gradlew -PxroadBuildType=RELEASE --parallel --stacktrace build -x test -x intTest runProxyTest runMetaserviceTest runProxymonitorMetaserviceTest jacocoTestReport dependencyCheckAggregate -Pfrontend-npm-audit
      - name: Run tests
        working-directory: ./src
        run: ./gradlew -PxroadBuildType=RELEASE --stacktrace test intTest
      - name: Build Jammy packages
        env:
          DEBEMAIL: 'info@niis.org'
          DEBFULLNAME: 'NIIS'
        run: ./src/packages/build-deb.sh jammy -release
      - name: Store deb files for system tests
        uses: actions/upload-artifact@v3
        with:
          name: debian-packages
          path: src/packages/build/ubuntu22.04/*.deb
  RunCSSystemTests:
    needs: BuildAndpackageWithUnitTests
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v3
        with:
          submodules: 'true'
      - name: Set up JDK 11 
        uses: actions/setup-java@v3
        with:
          java-version: '11'
          distribution: 'temurin'
      - name: Set up Gradle
        uses: gradle/gradle-build-action@v2
      - name: Download debian packages
        uses: actions/download-artifact@v3
        with:
          name: debian-packages
          path: ./.github/docker/centralserver/build/packages/develop/debian
      - name: Initialize docker setup
        run: |
          ./.github/docker/centralserver/init_context.sh
          ls -lah .github/docker/centralserver/build
      - name: Run Central Server system tests
        working-directory: ./src
        run: ./gradlew :central-server:admin-service:ui-system-test:systemTest -PsystemTestCsPackageHost=packages -PsystemTestCsDockerRoot=${{ github.workspace }}/.github/docker/centralserver
  RunSSSystemTests:
    needs: BuildAndpackageWithUnitTests
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v3
        with:
          submodules: 'true'
      - name: Set up JDK 11 
        uses: actions/setup-java@v3
        with:
          java-version: '11'
          distribution: 'temurin'
      - name: Set up Gradle
        uses: gradle/gradle-build-action@v2
      - name: Download debian packages
        uses: actions/download-artifact@v3
        with:
          name: debian-packages
          path: ./.github/docker/securityserver/build/packages/develop/debian
      - name: Run Security Server system tests
        working-directory: ./src
        run: ./gradlew :security-server:admin-service:ui-system-test:systemTest -PsystemTestSwwFckageHost=packages -PsystemTestSsDockerRoot=${{ github.workspace }}/.github/docker/securityserver
