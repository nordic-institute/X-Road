name: Build and Test
on:
  # Capture this event so that gradle caches are updated when a PR is merged to develop
  # More information on why: https://github.com/gradle/gradle-build-action#using-the-caches-read-only
  push:
    branches:
      - develop
    paths:
      - 'src/**'
      - '.github/**'
      - 'development/**'
  pull_request:
    types: [ opened, synchronize, reopened ]
    paths:
      - 'src/**'
      - '.github/**'
      - 'development/**'

permissions:
  contents: write # Required for https://github.com/gradle/actions/tree/main/setup-gradle#github-dependency-graph-support
  pull-requests: write # https://github.com/gradle/actions/tree/main/setup-gradle#adding-job-summary-as-a-pull-request-comment
  actions: read # Required for https://github.com/dorny/test-reporter
  checks: write # Required for https://github.com/dorny/test-reporter
  packages: write # Required to pull base images from GHCR and push application images

# Cancels previous workflow run on PR if a new one is started (does not affect push to develop).
# This is because github.head_ref is empty on push events so defaults to the unique github.run_id.
# More info: https://docs.github.com/en/actions/using-jobs/using-concurrency
concurrency:
  group: ${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  build-and-package:
    name: build & package
    uses: ./.github/workflows/_build-and-package.yml
    secrets: inherit
    with:
      ref: ${{ github.ref }}
      sha: ${{ github.sha }}

  test-central-server:
    name: cs-system-tests
    needs: build-and-package
    uses: ./.github/workflows/_test-central-server.yml
    secrets: inherit
    with:
      ref: ${{ github.ref }}
      sha: ${{ github.sha }}
      image_registry: ${{ needs.build-and-package.outputs.image_registry }}
      service_image_tag: ${{ needs.build-and-package.outputs.service_image_tag }}

  test-security-server:
    name: ss-system-tests
    needs: build-and-package
    uses: ./.github/workflows/_test-security-server.yml
    secrets: inherit
    with:
      ref: ${{ github.ref }}
      sha: ${{ github.sha }}
      image_registry: ${{ needs.build-and-package.outputs.image_registry }}
      service_image_tag: ${{ needs.build-and-package.outputs.service_image_tag }}

  test-e2e:
    name: e2e-tests
    needs: build-and-package
    uses: ./.github/workflows/_test-e2e.yml
    secrets: inherit
    with:
      ref: ${{ github.ref }}
      sha: ${{ github.sha }}
      image_registry: ${{ needs.build-and-package.outputs.image_registry }}
      service_image_tag: ${{ needs.build-and-package.outputs.service_image_tag }}

  test-services:
    name: service-int-tests
    needs: build-and-package
    uses: ./.github/workflows/_test-services.yml
    secrets: inherit
    with:
      ref: ${{ github.ref }}
      sha: ${{ github.sha }}
      image_registry: ${{ needs.build-and-package.outputs.image_registry }}
      service_image_tag: ${{ needs.build-and-package.outputs.service_image_tag }}

  build-summary:
    name: Build Summary
    needs: [build-and-package, test-central-server, test-security-server, test-e2e, test-services]
    if: always()
    runs-on: ubuntu-22.04
    steps:
      - name: Generate build summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          # Build and Test Summary
          
          | Job | Status | Duration |
          |-----|--------|----------|
          | Build and Package | ${{ needs.build-and-package.result == 'success' && 'âœ… Success' || needs.build-and-package.result == 'failure' && 'âŒ Failed' || needs.build-and-package.result == 'cancelled' && 'â¹ï¸ Cancelled' || 'â³ Skipped' }} | - |
          | Central Server Tests | ${{ needs.test-central-server.result == 'success' && 'âœ… Success' || needs.test-central-server.result == 'failure' && 'âŒ Failed' || needs.test-central-server.result == 'cancelled' && 'â¹ï¸ Cancelled' || 'â³ Skipped' }} | - |
          | Security Server Tests | ${{ needs.test-security-server.result == 'success' && 'âœ… Success' || needs.test-security-server.result == 'failure' && 'âŒ Failed' || needs.test-security-server.result == 'cancelled' && 'â¹ï¸ Cancelled' || 'â³ Skipped' }} | - |
          | E2E Tests | ${{ needs.test-e2e.result == 'success' && 'âœ… Success' || needs.test-e2e.result == 'failure' && 'âŒ Failed' || needs.test-e2e.result == 'cancelled' && 'â¹ï¸ Cancelled' || 'â³ Skipped' }} | - |
          | Service Integration Tests | ${{ needs.test-services.result == 'success' && 'âœ… Success' || needs.test-services.result == 'failure' && 'âŒ Failed' || needs.test-services.result == 'cancelled' && 'â¹ï¸ Cancelled' || 'â³ Skipped' }} | - |
          
          ## Overall Result
          
          ${{ (needs.build-and-package.result == 'success' && needs.test-central-server.result == 'success' && needs.test-security-server.result == 'success' && needs.test-e2e.result == 'success' && needs.test-services.result == 'success') && 'ðŸŽ‰ All tests passed!' || 'âš ï¸ Some tests failed or were skipped' }}
          
          ## Quick Actions
          
          - ðŸ”„ [Re-run failed jobs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - ðŸ› [View detailed logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - ðŸ“Š [Build trends](https://github.com/${{ github.repository }}/actions)
          EOF
