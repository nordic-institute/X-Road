name: Build Base Docker Images

on:
  # Build snapshots on develop branch
  push:
    branches:
      - develop-8.x
      - XRDDEV-3003
    paths:
      - 'deployment/security-server/base-images/**'
      - 'src/libs/pkcs11wrapper/**'
      - 'src/gradle.properties'
      - '.github/workflows/build-base-images.yaml'
  schedule:
    - cron: '0 2 * * *'
  
  # Allow manual triggering
  workflow_dispatch:
    inputs:
      version_override:
        description: 'Override version (optional)'
        required: false
        type: string

permissions:
  contents: read
  packages: write

env:
  REGISTRY: ghcr.io

jobs:
  build-base-images:
    name: Build and push base images
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0  # Need full history for git commit information

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build base images
        working-directory: ./deployment/security-server/base-images
        run: |
          # Determine version override if provided
          VERSION_ARG=""
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && -n "${{ inputs.version_override }}" ]]; then
            VERSION_ARG="--version ${{ inputs.version_override }}"
          fi
          
          # Build with unified script
          ./build-base-images.sh \
            --environment ci \
            --registry ${{ env.REGISTRY }} \
            --push \
            --summary-file /tmp/build-summary.md \
            $VERSION_ARG

      - name: Set packages as internal
        run: |
          # Set all base image packages as internal
          # Convert repository name to lowercase for consistency
          REPO_LOWERCASE=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          REPO_OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          REPO_NAME=$(echo "${{ github.repository }}" | cut -d'/' -f2 | tr '[:upper:]' '[:lower:]')
          
          IMAGES=(
            "ss-baseline-runtime"
            "ss-baseline-backup-manager-runtime" 
            "ss-baseline-signer-runtime"
          )
          
          echo "Repository: ${REPO_LOWERCASE}"
          echo "Repository owner: ${REPO_OWNER}"
          echo "Repository name: ${REPO_NAME}"
          echo "Waiting for packages to be fully available..."
          sleep 15  # Give time for packages to be created and indexed after push
          
          for image in "${IMAGES[@]}"; do
            # The package name in GitHub API corresponds to the full image path after ghcr.io/
            # For ghcr.io/nordic-institute/x-road/base-images/ss-baseline-runtime
            # The package name should be: x-road/base-images/ss-baseline-runtime (without the org prefix)
            PACKAGE_NAME="${REPO_NAME}%2Fbase-images%2F${image}"  # URL encode the slashes
            echo "Setting package ${REPO_NAME}/base-images/${image} as internal..."
            
            # Try organization packages API (most common for org repositories)
            echo "Checking organization packages API..."
            RESPONSE=$(curl -s -w "HTTP_STATUS:%{http_code}" \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "https://api.github.com/orgs/${REPO_OWNER}/packages/container/${PACKAGE_NAME}")
            
            HTTP_STATUS=$(echo $RESPONSE | grep -o "HTTP_STATUS:[0-9]*" | cut -d: -f2)
            
            if [[ "$HTTP_STATUS" == "200" ]]; then
              echo "âœ… Package found in organization, setting visibility..."
              curl -s -X PATCH \
                -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
                -H "Accept: application/vnd.github.v3+json" \
                -H "X-GitHub-Api-Version: 2022-11-28" \
                -H "Content-Type: application/json" \
                "https://api.github.com/orgs/${REPO_OWNER}/packages/container/${PACKAGE_NAME}" \
                -d '{"visibility":"internal"}' && echo "âœ… Visibility set to internal" || echo "âŒ Failed to set visibility"
            else
              echo "âš ï¸  Package not found via org API (HTTP $HTTP_STATUS)"
              
              # Try user packages API as fallback
              echo "Trying user packages API as fallback..."
              RESPONSE=$(curl -s -w "HTTP_STATUS:%{http_code}" \
                -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
                -H "Accept: application/vnd.github.v3+json" \
                -H "X-GitHub-Api-Version: 2022-11-28" \
                "https://api.github.com/user/packages/container/${PACKAGE_NAME}")
              
              HTTP_STATUS=$(echo $RESPONSE | grep -o "HTTP_STATUS:[0-9]*" | cut -d: -f2)
              
              if [[ "$HTTP_STATUS" == "200" ]]; then
                echo "âœ… Package found in user packages, setting visibility..."
                curl -s -X PATCH \
                  -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
                  -H "Accept: application/vnd.github.v3+json" \
                  -H "X-GitHub-Api-Version: 2022-11-28" \
                  -H "Content-Type: application/json" \
                  "https://api.github.com/user/packages/container/${PACKAGE_NAME}" \
                  -d '{"visibility":"internal"}' && echo "âœ… Visibility set to internal" || echo "âŒ Failed to set visibility"
              else
                echo "âš ï¸  Package not found via user API either (HTTP $HTTP_STATUS)"
                echo "ðŸ“‹ Manual setup required:"
                echo "   1. Go to https://github.com/${REPO_OWNER}?tab=packages"
                echo "   2. Find '${REPO_NAME}/base-images/${image}' package"
                echo "   3. Click Settings â†’ Change visibility â†’ Internal"
              fi
            fi
            echo
          done

      - name: Add build summary to step summary
        if: always()
        run: |
          if [[ -f /tmp/build-summary.md ]]; then
            cat /tmp/build-summary.md >> $GITHUB_STEP_SUMMARY
          else
            cat >> $GITHUB_STEP_SUMMARY << EOF
          # Base Images Build
          
          **Status:** Build completed
          **Trigger:** ${{ github.event_name }}
          **Branch/Tag:** ${{ github.ref_name }}
          
          Build summary file was not generated. Check workflow logs for details.
          EOF
          fi
