name: Build Base Docker Images

on:
  # Build snapshots on develop branch
  push:
    branches:
      - develop-8.x
      - XRDDEV-3003
    paths:
      - 'deployment/security-server/base-images/**'
      - 'src/libs/pkcs11wrapper/**'
      - 'src/gradle.properties'
      - '.github/workflows/build-base-images.yaml'
  schedule:
    - cron: '0 2 * * *'
  
  # Allow manual triggering
  workflow_dispatch:
    inputs:
      version_override:
        description: 'Override version (optional)'
        required: false
        type: string

permissions:
  contents: read
  packages: write

env:
  REGISTRY: ghcr.io

jobs:
  build-base-images:
    name: Build and push base images
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0  # Need full history for git commit information

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build base images
        working-directory: ./deployment/security-server/base-images
        run: |
          # Determine version override if provided
          VERSION_ARG=""
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && -n "${{ inputs.version_override }}" ]]; then
            VERSION_ARG="--version ${{ inputs.version_override }}"
          fi
          
          # Build with unified script
          ./build-base-images.sh \
            --environment ci \
            --registry ${{ env.REGISTRY }} \
            --push \
            --summary-file /tmp/build-summary.md \
            $VERSION_ARG

      - name: Set packages as internal
        run: |
          # Set all base image packages as internal
          IMAGES=(
            "ss-baseline-runtime"
            "ss-baseline-backup-manager-runtime" 
            "ss-baseline-signer-runtime"
          )
          
          for image in "${IMAGES[@]}"; do
            PACKAGE_NAME="base-images/${image}"
            echo "Setting ${PACKAGE_NAME} as internal..."
            
            # Update package visibility to internal
            curl -X PATCH \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              -H "Content-Type: application/json" \
              "https://api.github.com/orgs/${{ github.repository_owner }}/packages/container/${PACKAGE_NAME}" \
              -d '{"visibility":"internal"}' || true
          done

      - name: Add build summary to step summary
        if: always()
        run: |
          if [[ -f /tmp/build-summary.md ]]; then
            cat /tmp/build-summary.md >> $GITHUB_STEP_SUMMARY
          else
            cat >> $GITHUB_STEP_SUMMARY << EOF
          # Base Images Build
          
          **Status:** Build completed
          **Trigger:** ${{ github.event_name }}
          **Branch/Tag:** ${{ github.ref_name }}
          
          Build summary file was not generated. Check workflow logs for details.
          EOF
          fi
