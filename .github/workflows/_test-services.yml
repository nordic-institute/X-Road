name: Service Integration Tests

on:
  workflow_call:
    inputs:
      ref:
        description: 'Git ref to checkout'
        required: true
        type: string
      sha:
        description: 'Git SHA for the build'
        required: true
        type: string
      image_registry:
        description: 'Image registry URL'
        required: true
        type: string
      service_image_tag:
        description: 'Service image tag to use'
        required: true
        type: string

jobs:
  test-signer-service:
    name: Run Signer service integration tests
    runs-on: ubuntu-22.04
    steps:
      - name: Start Measurement
        uses: green-coding-solutions/eco-ci-energy-estimation@v5.0
        with:
          task: start-measurement
          label: 'Signer service integration tests'

      - uses: actions/checkout@v5
        with:
          ref: ${{ inputs.ref }}

      - name: Setup build environment
        uses: ./.github/actions/setup-build-env
        with:
          gradle-cache-read-only: true
          free-disk-space: false

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Signer test setup measurement
        uses: green-coding-solutions/eco-ci-energy-estimation@v5.0
        with:
          task: get-measurement
          label: 'Set up Signer service tests'

      - name: Run Signer integration tests
        working-directory: ./src
        run: |
          ./gradlew -Dorg.gradle.jvmargs=-Xmx1g :service:signer:signer-int-test:intTest \
            -PxroadImageRegistry=${{ inputs.image_registry }} \
            -PxroadImageTag=${{ inputs.service_image_tag }}

      - name: Log storage after tests
        if: always()
        uses: ./.github/actions/log-storage
        with:
          label: 'Storage After Signer Tests'
          show-docker-images: 'true'

      - name: Test Signer measurement
        uses: green-coding-solutions/eco-ci-energy-estimation@v5.0
        with:
          task: get-measurement
          label: 'Test Signer service'

      - name: Test report
        env:
          NODE_OPTIONS: '--max-old-space-size=6144'
        uses: dorny/test-reporter@v2
        if: success() || failure()
        with:
          name: Signer service integration tests
          path: src/service/signer/signer-int-test/build/test-results/**/TEST-*.xml
          reporter: java-junit

      - name: Upload Signer test report
        uses: actions/upload-artifact@v5
        if: failure()
        with:
          name: Signer Integration Test report
          path: |
            src/service/signer/signer-int-test/build/a2c_logs/
            src/service/signer/signer-int-test/build/allure-report/
            src/service/signer/signer-int-test/build/container-logs/

      - name: Show Energy Results
        uses: green-coding-solutions/eco-ci-energy-estimation@v5.0
        with:
          task: display-results
          pr-comment: true

  test-op-monitor-service:
    name: Run Operational Monitor service integration tests
    runs-on: ubuntu-22.04
    steps:
      - name: Start Measurement
        uses: green-coding-solutions/eco-ci-energy-estimation@v5.0
        with:
          task: start-measurement
          label: 'Operational Monitor service integration tests'

      - uses: actions/checkout@v5
        with:
          ref: ${{ inputs.ref }}

      - name: Setup build environment
        uses: ./.github/actions/setup-build-env
        with:
          gradle-cache-read-only: true
          free-disk-space: false

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Op-Monitor test setup measurement
        uses: green-coding-solutions/eco-ci-energy-estimation@v5.0
        with:
          task: get-measurement
          label: 'Set up Operational Monitor service tests'

      - name: Run Operational Monitor integration tests
        working-directory: ./src
        run: |
          ./gradlew -Dorg.gradle.jvmargs=-Xmx1g :service:op-monitor:op-monitor-int-test:intTest \
            -PxroadImageRegistry=${{ inputs.image_registry }} \
            -PxroadImageTag=${{ inputs.service_image_tag }}

      - name: Log storage after tests
        if: always()
        uses: ./.github/actions/log-storage
        with:
          label: 'Storage After Op-Monitor Tests'
          show-docker-images: 'true'

      - name: Test Op-Monitor measurement
        uses: green-coding-solutions/eco-ci-energy-estimation@v5.0
        with:
          task: get-measurement
          label: 'Test Operational Monitor service'

      - name: Test report
        env:
          NODE_OPTIONS: '--max-old-space-size=6144'
        uses: dorny/test-reporter@v2
        if: success() || failure()
        with:
          name: Operational Monitor service integration tests
          path: src/service/op-monitor/op-monitor-int-test/build/test-results/**/TEST-*.xml
          reporter: java-junit

      - name: Upload Op-Monitor test report
        uses: actions/upload-artifact@v5
        if: failure()
        with:
          name: Op-Monitor Integration Test report
          path: |
            src/service/op-monitor/op-monitor-int-test/build/a2c_logs/
            src/service/op-monitor/op-monitor-int-test/build/allure-report/
            src/service/op-monitor/op-monitor-int-test/build/container-logs/

      - name: Show Energy Results
        uses: green-coding-solutions/eco-ci-energy-estimation@v5.0
        with:
          task: display-results
          pr-comment: true
