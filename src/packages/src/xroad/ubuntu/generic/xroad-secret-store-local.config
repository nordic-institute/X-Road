#!/bin/bash -e

. /usr/share/debconf/confmodule

if [ "$1" = "configure" ] || [ "$1" = "reconfigure" ]; then
  # Get database connection string from the user
  db_connection_url=$(awk '/storage "postgresql"/,/\}/' /etc/openbao/openbao.hcl | grep 'connection_url' | cut -d'"' -f2)
  pat='^postgres://[^@]+@([^:/?#]+:[0-9]+)'
  if [[ "$db_connection_url" =~ $pat ]]; then
    db_host="${BASH_REMATCH[1]:-127.0.0.1:5432}"
    db_set xroad-common/database-host "$db_host" || true
  fi

  db_input critical xroad-common/database-host || true
  db_go

fi

db_stop
