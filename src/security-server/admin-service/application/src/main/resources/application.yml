# shared properties for dev/prod runtime
# test runtime has a separate application.properties
spring:
  application:
    name: proxy-ui-api
  datasource:
    url: ${xroad.common.serverconf.hibernate.connection.url}
    username: ${xroad.common.serverconf.hibernate.connection.username}
    password: ${xroad.common.serverconf.hibernate.connection.password}
    hikari:
      data-source-properties:
        currentSchema: ${xroad.common.serverconf.hibernate.hikari.dataSource.currentSchema}
  jpa:
    ## *.hbm.xml files are loaded from classpath
    mapping-resources: identifiers.hbm.xml,serverconf.hbm.xml,apikey.hbm.xml
    open-in-view: false
    hibernate:
      ddl-auto: none
      show-sql: true
      naming:
        physical-strategy: org.hibernate.boot.model.naming.PhysicalNamingStrategyStandardImpl
    properties:
      hibernate:
        dialect: ee.ria.xroad.common.db.CustomPostgreSQLDialect
        id:
          db_structure_naming_strategy: legacy #TODO Migrate to newer strategies
  mvc:
    throw-exception-if-no-handler-found: true
  jackson:
    default-property-inclusion: NON_NULL
  servlet:
    multipart:
      max-file-size: ${xroad.proxy-ui-api.request-size-limit-binary-upload}
      max-request-size: ${xroad.proxy-ui-api.request-size-limit-binary-upload}
  profiles:
    include: nontest
# TLS
# (can be overridden with external ssl.properties)
server:
  port: 4000
  servlet:
    session:
      cookie:
        secure: true
        same-site: Strict
  ssl:
    key-store: /etc/xroad/ssl/proxy-ui-api.p12
    key-store-password: proxy-ui-api
    enabled: true
    ciphers: TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384
    protocol: TLS
    enabled-protocols: TLSv1.2
  compression:
    enabled: true
    mime-types: application/json,application/xml,text/html,text/xml,text/plain,application/javascript,text/css,image/jpeg

logging.level:
  ee.ria.xroad.common.SystemPropertiesLoader: OFF

xroad:
  proxy-ui-api:
    rate-limit-requests-per-second: 20
    rate-limit-requests-per-minute: 600
    rate-limit-cache-size: 10_000
    rate-limit-expire-after-access-minutes: 5
    cache-default-ttl: 60
    cache-api-key-ttl: 60
    strict-identifier-checks: true
    request-size-limit-regular: 50KB
    request-size-limit-binary-upload: 10MB
  common:
    serverconf:
      cache-period: 60
      client-cache-size: 100
      service-cache-size: 1000
      acl-cache-size: 100_000
      hibernate:
        dialect: ee.ria.xroad.common.db.CustomPostgreSQLDialect
        connection.driver_class: org.postgresql.Driver
        connection.url: jdbc:postgresql://127.0.0.1:5432/serverconf
        connection.username: serverconf
        hikari.dataSource.currentSchema: serverconf,public
        jdbc.use_streams_for_binary: true

file-upload-endpoints:
  endpoint-definitions:
    - http-method: POST
      path-pattern: "/**/backups/upload"
    - http-method: POST
      path-pattern: "/**/tls-certificates"
    - http-method: POST
      path-pattern: "/**/token-certificates"
    - http-method: POST
      path-pattern: "/**/certificate/import"

script:
  generate-gpg-keypair:
    path: /usr/share/xroad/scripts/generate_gpg_keypair.sh
  generate-certificate:
    path: /usr/share/xroad/scripts/generate_certificate.sh
    args: -n internal -f -S -p 2>&1
  generate-backup:
    path: /usr/share/xroad/scripts/backup_xroad_proxy_configuration.sh
    valid-filename-pattern: "^(?!\\.)[\\w\\.\\-]+\\.gpg$"
  restore-configuration:
    path: /usr/share/xroad/scripts/restore_xroad_proxy_configuration.sh

common-module-endpoints:
  base-path: /api/v1

gpgkeys:
  gpghome: /etc/xroad/gpghome
