services:
  openbao:
    image: ${OPENBAO_DEV_IMG}
    pull_policy: always
    environment:
      - BAO_ADDR=http://0.0.0.0:8200
      - BAO_TOKEN=${XROAD_SECRET_STORE_ROOT_TOKEN}
      - XROAD_SECRET_STORE_TOKEN_OVERRIDE=${XROAD_SECRET_STORE_TOKEN:-}
    healthcheck:
      interval: 5s
      retries: 40
      test: [ "CMD", "sh", "-c", "bao secrets list -format=json | jq 'has(\"xrd-pki/\")' | grep -q true" ]
    deploy:
      resources:
        reservations:
          memory: 64M
        limits:
          memory: 256M
  signer:
    build:
      context: ./signer-container-files/
      args:
        - SIGNER_IMG=${SIGNER_IMG}
      dockerfile: Dockerfile
    pull_policy: always
    environment:
      - XROAD_HOST=signer
      - XROAD_SECRET_STORE_HOST=openbao
      - XROAD_SECRET_STORE_TOKEN=${XROAD_SECRET_STORE_TOKEN}
      - XROAD_SECRET_STORE_SCHEME=http
      - XROAD_COMMON_RPC_USE_TLS=false
      - XROAD_COMMON_GLOBAL_CONF_SOURCE=FILESYSTEM
      - XROAD_SIGNER_OCSP_RESPONSE_RETRIEVAL_ACTIVE=true
      - XROAD_DB_SERVERCONF_HIBERNATE_CONNECTION_URL=jdbc:postgresql://db-serverconf:5432/serverconf
      - XROAD_DB_SERVERCONF_HIBERNATE_CONNECTION_DRIVER_CLASS=org.postgresql.Driver
      - XROAD_DB_SERVERCONF_HIBERNATE_CONNECTION_USERNAME=serverconf
      - XROAD_DB_SERVERCONF_HIBERNATE_CONNECTION_PASSWORD=secret
      - XROAD_SIGNER_RPC_LISTEN_ADDRESS=0.0.0.0
      - XROAD_SIGNER_AUTOLOGIN_ENABLED=true
      - XROAD_SIGNER_AUTOLOGIN_TOKENS__0__PIN=4321
      - XROAD_SIGNER_ADDON_HWTOKEN_ENABLED=true
      - XROAD_SIGNER_ADDON_HWTOKEN_SESSION_POOL_ENABLED=true
      - XROAD_SIGNER_ADDON_HWTOKEN_SESSION_POOL_MAX_TOTAL=3
      - XROAD_SIGNER_ADDON_HWTOKEN_SESSION_POOL_MAX_IDLE=2
      - XROAD_SIGNER_ADDON_HWTOKEN_SESSION_POOL_MIN_IDLE=1
      - XROAD_SIGNER_ADDON_HWTOKEN_SESSION_ACQUIRE_TIMEOUT=5S
      - XROAD_SIGNER_MODULES_SOFTHSM2_LIBRARY=/usr/lib/softhsm/libsofthsm2.so
      - XROAD_SIGNER_MODULES_SOFTHSM2_OS_LOCKING_OK=true
      - XROAD_SIGNER_MODULES_SOFTHSM2_LIBRARY_CANT_CREATE_OS_THREADS=true
      - QUARKUS_LOG_LEVEL=INFO
      - QUARKUS_LOG_CATEGORY__ORG_NIIS_XROAD_SIGNER__LEVEL=DEBUG
    ports:
      - "0:9999" # debug port
    healthcheck:
      interval: 5s
      retries: 40
      test: [ "CMD", "curl", "-f", "-k", "http://localhost:4099/q/health" ]
    depends_on:
      db-serverconf-init:
        condition: service_completed_successfully
      openbao:
        condition: service_healthy
    deploy:
      resources:
        reservations:
          memory: 96M
        limits:
          memory: 512M
    volumes:
      - ./signer-container-files/etc/xroad/globalconf:/etc/xroad/globalconf
      - softhsm-tokens:/var/lib/softhsm/tokens/
  signer-secondary:
    build:
      context: ./signer-container-files/
      args:
        - SIGNER_IMG=${SIGNER_IMG}
      dockerfile: Dockerfile
    pull_policy: always
    environment:
      - XROAD_HOST=signer-secondary
      - XROAD_SECRET_STORE_HOST=openbao
      - XROAD_SECRET_STORE_TOKEN=${XROAD_SECRET_STORE_TOKEN}
      - XROAD_SECRET_STORE_SCHEME=http
      - XROAD_COMMON_RPC_USE_TLS=false
      - XROAD_COMMON_GLOBAL_CONF_SOURCE=FILESYSTEM
      - XROAD_SIGNER_OCSP_RESPONSE_RETRIEVAL_ACTIVE=true
      - XROAD_DB_SERVERCONF_HIBERNATE_CONNECTION_URL=jdbc:postgresql://db-serverconf:5432/serverconf
      - XROAD_DB_SERVERCONF_HIBERNATE_CONNECTION_DRIVER_CLASS=org.postgresql.Driver
      - XROAD_DB_SERVERCONF_HIBERNATE_CONNECTION_USERNAME=serverconf
      - XROAD_DB_SERVERCONF_HIBERNATE_CONNECTION_PASSWORD=secret
      - XROAD_NODE_TYPE=secondary
      - XROAD_SIGNER_RPC_LISTEN_ADDRESS=0.0.0.0
      - XROAD_SIGNER_ADDON_HWTOKEN_ENABLED=true
      - XROAD_SIGNER_ADDON_HWTOKEN_SESSION-POOL-ENABLED=true
      - XROAD_SIGNER_ADDON_HWTOKEN_SESSION-POOL-MAX-TOTAL=3
      - XROAD_SIGNER_ADDON_HWTOKEN_SESSION-POOL-MAX-IDLE=2
      - XROAD_SIGNER_ADDON_HWTOKEN_SESSION-POOL-MIN-IDLE=1
      - XROAD_SIGNER_ADDON_HWTOKEN_SESSION-ACQUIRE-TIMEOUT=5S
      - XROAD_SIGNER_MODULES_SOFTHSM2_LIBRARY=/usr/lib/softhsm/libsofthsm2.so
      - XROAD_SIGNER_MODULES_SOFTHSM2_OS_LOCKING_OK=true
      - XROAD_SIGNER_MODULES_SOFTHSM2_LIBRARY_CANT_CREATE_OS_THREADS=true
      - QUARKUS_LOG_LEVEL=INFO
      - QUARKUS_LOG_CATEGORY__ORG_NIIS_XROAD_SIGNER__LEVEL=DEBUG
    ports:
      - "0:9999" # debug port
    healthcheck:
      interval: 5s
      retries: 40
      test: [ "CMD", "curl", "-f", "-k", "http://localhost:4099/q/health" ]
    depends_on:
      db-serverconf-init:
        condition: service_completed_successfully
      signer:
        condition: service_healthy
    deploy:
      resources:
        reservations:
          memory: 96M
        limits:
          memory: 512M
    volumes:
      - ./signer-container-files/etc/xroad/globalconf:/etc/xroad/globalconf
      - softhsm-tokens:/var/lib/softhsm/tokens/
  db-serverconf:
    image: postgres:17
    environment:
      - POSTGRES_DB=serverconf
      - POSTGRES_PASSWORD=secret
      - POSTGRES_USER=serverconf
    ports:
      - "0:5432"
    healthcheck:
      start_period: 5s
      interval: 5s
      retries: 40
      test: [ "CMD", "pg_isready", "-U", "serverconf", "-h", "localhost" ]
    deploy:
      resources:
        reservations:
          memory: 64M
        limits:
          memory: 256M
  db-serverconf-init:
    image: ${SERVERCONF_INIT_IMG}
    pull_policy: always
    environment:
      - LIQUIBASE_COMMAND_USERNAME=serverconf
      - LIQUIBASE_COMMAND_PASSWORD=secret
      - LIQUIBASE_COMMAND_URL=jdbc:postgresql://db-serverconf:5432/serverconf
      - db_user=serverconf
      - db_schema=public
    depends_on:
      db-serverconf:
        condition: service_healthy
    deploy:
      resources:
        reservations:
          memory: 64M
        limits:
          memory: 512M
  testca:
    image: ${CA_IMG}
    pull_policy: always
    healthcheck:
      interval: 5s
      retries: 40
      test: [ "CMD", "curl", "-f", "http://localhost:8888/testca/certs/" ]

volumes:
  softhsm-tokens:
