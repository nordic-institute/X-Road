#!/bin/bash

# load grpc settings
if [ -f /var/run/xroad/xroad-grpc-internal-env.properties ]; then
  set -a
  . /var/run/xroad/xroad-grpc-internal-env.properties
  set +a
fi

echo "DS: Running liquibase.."
source /usr/share/xroad/scripts/setup_edc_dataplane_db.sh

exec java -Dedc.fs.config="/etc/xroad-edc/edc-data-plane.properties" \
    -Dserverconf.hibernate.hikari.maximumPoolSize=1 \
    -Xdebug -agentlib:jdwp=transport=dt_socket,address=*:9954,server=y,suspend=n \
    -javaagent:/usr/share/xroad/jlib/opentelemetry-javaagent.jar \
    -Dotel.exporter.otlp.protocol=http/protobuf \
    -Dotel.service.name="$EDC_HOSTNAME-edc-data-plane" \
    -Dotel.exporter.prometheus.port=9464 \
    -Dotel.metrics.exporter=prometheus \
    -Dotel.exporter.otlp.endpoint=http://jaeger:4318 \
    -Xmx256m -jar /usr/share/xroad/jlib/edc-data-plane.jar
