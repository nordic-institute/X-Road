services:
  cs:
    image: ${CS_IMG}
    container_name: cs
    deploy:
      resources:
        reservations:
          memory: 512M
        limits:
          memory: 2560M
    healthcheck:
      interval: 5s
      retries: 40
      test: [ "CMD", "curl", "-f", "-k", "https://localhost:4000" ]
    networks:
      - xroad-network
  ss0:
    image: ${SS_IMG}
    container_name: ss0
    deploy:
      resources:
        reservations:
          memory: 512M
        limits:
          memory: 2560M
    healthcheck:
      interval: 5s
      retries: 40
      test: [ "CMD", "curl", "-f", "-k", "https://localhost:4000" ]
    networks:
      - xroad-network
  ss1:
    image: ${SS_IMG}
    container_name: ss1
    deploy:
      resources:
        reservations:
          memory: 512M
        limits:
          memory: 2560M
    healthcheck:
      interval: 5s
      retries: 40
      test: [ "CMD", "curl", "-f", "-k", "https://localhost:4000" ]
    networks:
      - xroad-network
  testca:
    image: ${CA_IMG}
    container_name: testca
    deploy:
      resources:
        reservations:
          memory: 32M
        limits:
          memory: 512M
    healthcheck:
      interval: 5s
      retries: 40
      test: [ "CMD", "curl", "-f", "-k", "http://localhost:8888/testca/certs" ]
    volumes:
      - ca-volume:/home/ca/certs
    networks:
      - xroad-network
  issoap:
    image: ${IS_SOAP_IMG}
    container_name: issoap
    deploy:
      resources:
        reservations:
          memory: 64M
        limits:
          memory: 512M
    healthcheck:
      interval: 5s
      retries: 40
      test: [ "CMD", "curl", "-f", "-k", "http://localhost:8080/example-adapter/Endpoint?wsdl" ]
    entrypoint: ["java", "-Xms64m", "-Xmx256m", "-jar", "/example-adapter.war"]
    networks:
      - xroad-network
  isrest:
    image: wiremock/wiremock:latest
    container_name: isrest
    deploy:
      resources:
        reservations:
          memory: 64M
        limits:
          memory: 256M
    healthcheck:
      interval: 5s
      retries: 40
      test: [ "CMD", "curl", "-f", "-k", "http://localhost:8080/__admin/health" ]
    volumes:
      - ./wiremock_mappings:/home/wiremock/mappings
    networks:
      - xroad-network
  hurl:
    image: ghcr.io/orange-opensource/hurl:latest
    deploy:
      resources:
        reservations:
          memory: 24M
        limits:
          memory: 128M
    volumes:
      - ./hurl-src:/hurl-src
      - ca-volume:/hurl-files/ca
    depends_on:
      cs:
        condition: service_healthy
      testca:
        condition: service_healthy
      ss0:
        condition: service_healthy
      ss1:
        condition: service_healthy
      issoap:
        condition: service_healthy
      isrest:
        condition: service_healthy
    networks:
      - xroad-network
volumes:
  ca-volume:
networks:
  # Use implicitly named network so that is easier to add container outside the compose
  xroad-network:
    name: xroad-network
    driver: bridge
