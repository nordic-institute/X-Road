# Additional settings for local edc env.
# Rules:
# 1. Each container has its own port range. Ex: 4100-4199, 4200-4299, etc.

services:
  ss0:
    environment:
      - EDC_HOSTNAME=ss0
      - EDC_DID=did:web:did-server:ss0
      - EDC_DID_KEY_ID=3D47895272492D2A5950CD3936D89B69374EDB22
      - EDC_TRUSTED_ISSUER=ss1
      - EDC_TRUSTED_ISSUER_DID=did:web:did-server:ss1
    ports:
      - "4293:9953" #EDC debug
      - "4251:9191" #EDC api port
      - "4252:9192" #EDC control port
      - "4253:9193" #EDC management port
      - "4254:9194" #EDC protocol port
      - "4255:9291" #EDC public port
      - "4256:9293" #EDC XRD public port
  ss1:
    environment:
      - EDC_HOSTNAME=ss1
      - EDC_DID=did:web:did-server:ss1
      - EDC_DID_KEY_ID=ABB413254BE603BE8A1C94193041A2D82E8BDF4B
      - EDC_TRUSTED_ISSUER=ss0
      - EDC_TRUSTED_ISSUER_DID=did:web:did-server:ss0
    ports:
      - "4393:9953" #EDC debug
      - "4351:9191" #EDC api port
      - "4352:9192" #EDC control port
      - "4353:9193" #EDC management port
      - "4354:9194" #EDC protocol port
      - "4355:9291" #EDC public port
      - "4356:9293" #EDC XRD public port

  miw:
    image: tractusx/managed-identity-wallet:main
    platform: linux/amd64
    env_file:
      - ./.env.miw
    ports:
      - "8000:8000"
      - "8090:8090"
      - "5005:5005"
    entrypoint: "java -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:5005 -jar miw-latest.jar"
    depends_on:
      postgres:
        condition: service_started
      keycloak:
        condition: service_started

  postgres:
    image: postgres:15.3-alpine3.18
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./postgres/db.sh:/docker-entrypoint-initdb.d/init-database.sh
    env_file:
      - ./.env.miw
    ports:
      - "5432:5432"
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U postgres" ]
      interval: 5s
      timeout: 30s
      retries: 10

  keycloak:
    image: quay.io/keycloak/keycloak:21.1
    env_file:
      - ./.env.miw
    environment:
      DB_SCHEMA: public
    command:
      - start-dev
      - --import-realm
    volumes:
      - ./keycloak/miw_test_realm.json:/opt/keycloak/data/import/miw_test_realm.json
      - ./keycloak/health-check.sh:/opt/keycloak/health-check.sh
    ports:
      - "8080:8080"
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: "bash /opt/keycloak/health-check.sh"
      interval: 10s
      timeout: 10s
      retries: 15

volumes:
  postgres_data:
    driver: local